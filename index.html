<!doctype html>
<html>
  <head>
    <meta charset="utf-8" http-equiv="content-type" name="viewport" content="width=device-width, initial-scale=1">  
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

	<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
        <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <style>
      body { font: 16px Helvetica, Arial; background-color:#424242;}  
	  
      .auto {border: 2px solid #212121; padding:5px; margin-top:5px; position: relative; height:500px;  overflow:auto; background-color:#616161}
	  
      * { margin: 0; padding: 0; box-sizing: border-box;}
	  
      .down{ background: #616161; padding: 3px;position: fixed; bottom: 0;width:73%;}
	  
      #messages { list-style-type: none; margin: 0; padding: 0; color: white;}
	  
      #messages li { border-radius: 9px; padding: 5px; background-color: #29B6F6; border: 1px solid #212121;}
	  	  
      #messages li:nth-child(odd) { background: #eee;  background-color: #29B6F6;} 
	  
	  .logo{ color:#0033ff; }
	  
	  .nickchange{border: 2px solid #212121; float: left; margin-left: 20px; margin-top: 20px; color: red;}
	  
	  .listofusers{border: 2px solid #212121; float : right; width : 150px; height: 200px; margin-right: 20px; margin-top: 20px; color: red;}}
	  
	  .nicktext {background-color: white;}
	  
	  .nickmessage {border: 1px solid #212121;}
	  
	  .messageinput {border: 0; padding: 10px; background-color : #0277BD;}
	  
	  .nickchangeinput {border-radius: 5px; margin-left: 3px; color: black; width: 130px; background-color: #424242; border-color: black;}
	  
	  .nickchangebutton {width : 100px; margin-left : 15px;}
	  
	  .type-normal { border-radius: 9px; padding: 5px; background-color: #29B6F6; border: 1px solid #212121;}
	  
	  .type-system {  border-radius: 9px; padding: 5px; background-color: #9900cc!important; border: 1px solid #212121;}
	  
	  </style>
  </head>
  
   <body>
   		<!--<div class = "col-ms-2">
			<p align = "center" > Wpisz swój nick </p>
				<form action>
					<input type="text" name="nickchange" id = "nick" class = "nickchangeinput" />
				</form>
			<button class= "btn btn-success nickchangebutton"> Zmien </button>
		</div>
		<div class = "col-ms-4 listofusers">
			<p align = "center" > Lista użytkowników </p>
			<ul id="users" >
			</ul>
		</div>-->

	<div class = "col-sm-1 col-md-1 col-lg-1"></div>

    <div class = "col-sm-10 col-md-10 col-lg-10">

		<div class="col-top">
			<img src = "http://localhost:5000/img/bluebird.png" alt="BLUEBIRD CHAT" height="50px"/>
		</div>

		<div>
			<div class="col-sm-12 col-md-4 col-lg-4" id="helloMessage" >Welcome [nick] </div>
			<div class="col-sm-12 col-md-8 col-lg-8" align="right">
				<form action>
					<input type="text" name="nickchange" id = "nick" class = "nickchangeinput" value="Change name." onfocus="(this.value ='')" />
			<button class="btn btn-success nickchangebutton"> Zmien </button>
			</form>
			</div>
		</div>

		<div class="row auto messages-scroll col-sm-12 col-md-12 col-lg-12">
			<ul id="messages">
			</ul>
        </div>

        <div class="col-bottom col-xs-12 col-sm-12 col-md-12 col-lg-12" style="margin-top: 5px;">
            <form action ="">
				<input class = "col-xs-8 col-sm-10 col-md-10 col-lg-11 messageinput" id="m" autocomplete="off" />
				<div align="left" style="margin-left: 5px;"> 
				<button class = "btn btn-lg btn-primary">Send</button>
				<div>
            </form>  
		</div>   

        <script>
          var socket = io({
				transports: [
					'polling', 
					],
				'polling duration' : 10
			});
		    var id = "user" + guid();
			function guid() {
				function s4() {
					return Math.floor((Math.random()) * 0x10000)
				}
				return s4() + s4();
			}

			/**
      	* Add new message to chat
        * @param type string normal|system
        * @param message string
        */
			function appendChatMessage(type, nick, message) {
      		if( type != "normal" && type != "system" ) {
          	throw "Unsported type";
            return false;
          }

					var typeClass = "type-" + type;
  
            var li = $('<li class="'+typeClass+'"><b class="nickname"></b><span class="msg"></span></li>');
			$('#messages').append(li);
			li.find('.nickname').text(nick)
			li.find('.msg').text(message)

			
		  	$(".auto").scrollTop($(".messages-scroll")[0].scrollHeight) 
      }
      
      

			/**
       * User joined chat
       */
		socket.emit('user.joined', id );
	   	socket.on('user.joined', function(id){
		appendChatMessage("system", id + " joined this room.");
        });
		
			/**
       * Send message to server, when form is submited
       */      
      $('form').submit(function(){
      		var msgg = $('#m').val();
		  	  if (msgg.replace(/ /g,'') != '')	 {
          	socket.emit('message to server', {id: id, message: msgg });
		 				$('#m').val('');
	      	}
          return false;
      });
	  
	  
       /**
       * Change user id to nickname.
       */
      
		 var nick;
      		socket.on('user.changeid', function(data){                    		
                 appendChatMessage("system", data.id +  " zmienił nazwę na " + data.nick)
              id = nick;
              $('#nick').val('Change name');
			});
                                            
                                            
                                            
		  $('.nickchangebutton').on('click', function(){
		  	nick = $('#nick').val();
			if (nick.replace(/ /g,'') != '' && nick.match(/^[0-9a-zA-Z]{1,16}$/)){
				socket.emit('user.changeid', {id: id, nick: nick });
			} else {
				alert("Nieprawidłowy nick");
			}
				
		 });
      
      /**
       * Receive message from server and append it to chat.
       */
      socket.on('message from server', function(msg){
      	appendChatMessage("normal", msg.id + " : " + msg.message)
      });
        </script>
    </div>
  </body>
</html>
